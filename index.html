<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.chord {
  fill-opacity: .67;
}

path.fade {
  display: none;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>

var outerRadius = 600 / 2,
    innerRadius = outerRadius - 130;

var chord = d3.layout.chord()
    .padding(.04)
    .sortSubgroups(d3.ascending)
    .sortChords(d3.ascending);

var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(innerRadius + 20);

var svg = d3.select("body").append("svg")
    .attr("width", outerRadius * 3)
    .attr("height", outerRadius * 3)
  .append("g")
    .attr("transform", "translate(" + outerRadius * 1.5 + "," + outerRadius * 1.5 + ")");

var 
  indexByName = d3.map(),
  nameByIndex = d3.map(),
  typeByIndex = d3.map(),
  matrix = [],
  n = 0,
  col = "",
  ministers = [];

var colors = {
  "minister": "#FC9E41",
  "committee": "#3B53AB",
  "taskforce": "#31BC55"
}

d3.csv("https://docs.google.com/spreadsheets/d/1dUqIz412EMXfGnzqCaIIHhbAv9_wks5u4heNXfgIvpg/pub?gid=0&single=true&output=csv")
  .row(function (committee) {
    if (matrix.length === 0) {
      for (col in committee) {
        if (col !== "Committee/ Taskforce" && col !== "Name" && col !== "Terms of Reference" && col !== "Link" && col !== "Date") {
          matrix[n] = [];
          nameByIndex.set(n, col);
          typeByIndex.set(n, "minister");
          indexByName.set(col,n++);
        }
      };
      ministers = indexByName.keys();
    }

    nameByIndex.set(n, committee["Name"]);
    typeByIndex.set(n, committee["Committee/ Taskforce"] === "C" ? "committee" : "taskforce");
    indexByName.set(committee["Name"], n++);

    source = indexByName.get(committee["Name"]);
    matrix[source] = [];
    for (var m = 0; m < ministers.length; m++) {
      var minister = ministers[m];
      if (committee[minister] === 'A') {
        matrix[source][indexByName.get(minister)] = 1;
        matrix[indexByName.get(minister)][source] = 1;
      } else if (committee[minister] === 'C') {
        matrix[source][indexByName.get(minister)] = 2;
        matrix[indexByName.get(minister)][source] = 2;
      }
    }
    return committee;
  }).get(function(error, rows) {
    if (error) {
      console.log(error);
      return;
    }

    for (var i = 0; i < n; i++) {
      for (var j = 0; j < n; j++) {
        if (matrix[i][j] === undefined) matrix[i][j] = 0;
      }
    }

    chord.matrix(matrix);

    var g = svg.selectAll(".group")
        .data(chord.groups)
      .enter().append("g")
        .attr("class", "group")
        .on("mouseover", mouseover);

    g.append("path")
        .style("fill", function(d) { return colors[typeByIndex.get(d.index)]; })
        .style("stroke", function(d) { return colors[typeByIndex.get(d.index)]; })
        .attr("d", arc);

    g.append("text")
        .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
        .attr("dy", ".35em")
        .attr("transform", function(d) {
          return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
              + "translate(" + (innerRadius + 26) + ")"
              + (d.angle > Math.PI ? "rotate(180)" : "");
        })
        .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
        .text(function(d) { return nameByIndex.get(d.index); });

    var chords = svg.selectAll(".chord")
        .data(chord.chords)
      .enter().append("path")
        .attr("class", "chord")
        .style("stroke", function(d) { return d.target.value === 2 ? colors[typeByIndex.get(d.target.index)] : "none" ; })
        .style("fill", function(d) { return colors[typeByIndex.get(d.target.index)]; })
        .attr("d", d3.svg.chord().radius(innerRadius));

    d3.select(self.frameElement)
      .style("height", outerRadius * 2 + "px");

    svg
      .on("click", showAll);

    function mouseover(d, i) {
      chords.classed("fade", function(p) {
        return p.source.index != i
            && p.target.index != i;
      });
    }

    function showAll() {
      chords.classed("fade", false);
    }
  });

</script>